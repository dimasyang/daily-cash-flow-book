
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥æ”¶ä»˜æ¬¾ç´€éŒ„ - Firestore</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    input, select { margin: 0.5rem; padding: 0.4rem; }
    table { border-collapse: collapse; margin-top: 2rem; width: 100%; }
    th, td { border: 1px solid #aaa; padding: 0.5rem; text-align: center; }
  </style>
</head>
<body>

  <h2>ğŸ“’ æ¯æ—¥æ”¶ä»˜æ¬¾ç´€éŒ„ (Firestore é›²ç«¯ç‰ˆ)</h2>

  <label>æ—¥æœŸï¼š
    <input type="date" id="date" value="">
  </label>
  <label>é¡å‹ï¼š
    <select id="type">
      <option value="æ”¶å…¥">æ”¶å…¥</option>
      <option value="æ”¯å‡º">æ”¯å‡º</option>
    </select>
  </label>
  <label>é‡‘é¡ï¼š
    <input type="number" id="amount" placeholder="è«‹è¼¸å…¥é‡‘é¡">
  </label>
  <label>é¡åˆ¥ï¼š
    <input type="text" id="category" placeholder="åˆ†é¡">
  </label>
  <label>å‚™è¨»ï¼š
    <input type="text" id="note" placeholder="å‚™è¨»">
  </label>
  <button onclick="submitData()">å„²å­˜</button>
  <button onclick="fetchData()">é‡æ–°æ•´ç†</button>

  <h3>â˜ï¸ é›²ç«¯ç´€éŒ„æ˜ç´°</h3>
  <button onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
<label>èµ·æ—¥:<input type="date" id="startDate"></label>
<label>è¿„æ—¥:<input type="date" id="endDate"></label>
<button onclick="exportCSV()">â¬‡ï¸ åŒ¯å‡ºå€é–“ CSV</button>
<table id="recordTable">
    <thead>
      <tr>
    <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
    <th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>é¡åˆ¥</th><th>å‚™è¨»</th>
  </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js">
    function toggleAll(el) {
      document.querySelectorAll(".rowCheck").forEach(chk => chk.checked = el.checked);
    }

    function deleteSelected() {
      const checked = [...document.querySelectorAll(".rowCheck:checked")];
      if (checked.length === 0) return alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è³‡æ–™");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é¸å–çš„è³‡æ–™å—ï¼Ÿ")) return;

      const batch = db.batch();
      checked.forEach(chk => {
        const id = chk.getAttribute("data-id");
        const ref = db.collection("daily_cash").doc(id);
        batch.delete(ref);
      });

      batch.commit().then(() => {
        alert("âœ… å·²åˆªé™¤");
        fetchData();
      });
    }

    function exportCSV() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!start || !end) return alert("è«‹é¸æ“‡èµ·æ—¥èˆ‡è¿„æ—¥");

      const startDate = new Date(start);
      const endDate = new Date(end);
      endDate.setDate(endDate.getDate() + 1); // include end day

      db.collection("daily_cash").orderBy("createdAt", "desc").get().then(snapshot => {
        const now = new Date();
        const month = now.toISOString().slice(0, 7); // yyyy-mm
        const rows = [["æ—¥æœŸ", "é¡å‹", "é‡‘é¡", "é¡åˆ¥", "å‚™è¨»"]];
        snapshot.forEach(doc => {
          const d = doc.data();
          const dDate = new Date(d.æ—¥æœŸ); if (dDate >= startDate && dDate < endDate) {
            rows.push([d.æ—¥æœŸ, d.é¡å‹, d.é‡‘é¡, d.é¡åˆ¥, d.å‚™è¨»]);
          }
        });

        const csv = "\ufeff" + rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `daily_cash_${month}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js">
    function toggleAll(el) {
      document.querySelectorAll(".rowCheck").forEach(chk => chk.checked = el.checked);
    }

    function deleteSelected() {
      const checked = [...document.querySelectorAll(".rowCheck:checked")];
      if (checked.length === 0) return alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è³‡æ–™");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é¸å–çš„è³‡æ–™å—ï¼Ÿ")) return;

      const batch = db.batch();
      checked.forEach(chk => {
        const id = chk.getAttribute("data-id");
        const ref = db.collection("daily_cash").doc(id);
        batch.delete(ref);
      });

      batch.commit().then(() => {
        alert("âœ… å·²åˆªé™¤");
        fetchData();
      });
    }

    function exportCSV() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!start || !end) return alert("è«‹é¸æ“‡èµ·æ—¥èˆ‡è¿„æ—¥");

      const startDate = new Date(start);
      const endDate = new Date(end);
      endDate.setDate(endDate.getDate() + 1); // include end day

      db.collection("daily_cash").orderBy("createdAt", "desc").get().then(snapshot => {
        const now = new Date();
        const month = now.toISOString().slice(0, 7); // yyyy-mm
        const rows = [["æ—¥æœŸ", "é¡å‹", "é‡‘é¡", "é¡åˆ¥", "å‚™è¨»"]];
        snapshot.forEach(doc => {
          const d = doc.data();
          const dDate = new Date(d.æ—¥æœŸ); if (dDate >= startDate && dDate < endDate) {
            rows.push([d.æ—¥æœŸ, d.é¡å‹, d.é‡‘é¡, d.é¡åˆ¥, d.å‚™è¨»]);
          }
        });

        const csv = "\ufeff" + rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `daily_cash_${month}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  </script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAYmv1mt2QV0Ex0J1PlASfZjA3bdBvIJws",
      authDomain: "haishang-a09c3.firebaseapp.com",
      projectId: "haishang-a09c3",
      storageBucket: "haishang-a09c3.firebasestorage.app",
      messagingSenderId: "457535470987",
      appId: "1:457535470987:web:c94320eb296696e132838e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById('date').value = new Date().toISOString().slice(0, 10);

    function submitData() {
      const data = {
        æ—¥æœŸ: document.getElementById('date').value,
        é¡å‹: document.getElementById('type').value,
        é‡‘é¡: parseInt(document.getElementById('amount').value),
        é¡åˆ¥: document.getElementById('category').value,
        å‚™è¨»: document.getElementById('note').value,
        createdAt: new Date()
      };

      db.collection("daily_cash").add(data).then(() => {
        alert("âœ… å„²å­˜æˆåŠŸï¼");
        fetchData();
      }).catch((err) => {
        alert("âŒ éŒ¯èª¤ï¼š" + err.message);
      });
    }

    function fetchData() {
      db.collection("daily_cash").orderBy("createdAt", "desc").get().then((querySnapshot) => {
        const tbody = document.querySelector("#recordTable tbody");
        tbody.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const row = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
    <td><input type="checkbox" class="rowCheck" data-id="${doc.id}"></td>
    <td>${row.æ—¥æœŸ}</td><td>${row.é¡å‹}</td><td>${row.é‡‘é¡}</td><td>${row.é¡åˆ¥}</td><td>${row.å‚™è¨»}</td>
  `;
          tbody.appendChild(tr);
        });
      });
    }

    fetchData();
  
    function toggleAll(el) {
      document.querySelectorAll(".rowCheck").forEach(chk => chk.checked = el.checked);
    }

    function deleteSelected() {
      const checked = [...document.querySelectorAll(".rowCheck:checked")];
      if (checked.length === 0) return alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è³‡æ–™");
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é¸å–çš„è³‡æ–™å—ï¼Ÿ")) return;

      const batch = db.batch();
      checked.forEach(chk => {
        const id = chk.getAttribute("data-id");
        const ref = db.collection("daily_cash").doc(id);
        batch.delete(ref);
      });

      batch.commit().then(() => {
        alert("âœ… å·²åˆªé™¤");
        fetchData();
      });
    }

    function exportCSV() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!start || !end) return alert("è«‹é¸æ“‡èµ·æ—¥èˆ‡è¿„æ—¥");

      const startDate = new Date(start);
      const endDate = new Date(end);
      endDate.setDate(endDate.getDate() + 1); // include end day

      db.collection("daily_cash").orderBy("createdAt", "desc").get().then(snapshot => {
        const now = new Date();
        const month = now.toISOString().slice(0, 7); // yyyy-mm
        const rows = [["æ—¥æœŸ", "é¡å‹", "é‡‘é¡", "é¡åˆ¥", "å‚™è¨»"]];
        snapshot.forEach(doc => {
          const d = doc.data();
          const dDate = new Date(d.æ—¥æœŸ); if (dDate >= startDate && dDate < endDate) {
            rows.push([d.æ—¥æœŸ, d.é¡å‹, d.é‡‘é¡, d.é¡åˆ¥, d.å‚™è¨»]);
          }
        });

        const csv = "\ufeff" + rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `daily_cash_${month}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  </script>
</body>
</html>
